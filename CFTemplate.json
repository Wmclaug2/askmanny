{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "FunctionName": {
            "Description": "Give your Skill Function a Friendly Name",
            "Type": "String",
            "Default": "my-awesome-alexa-skill"
        },
        "BucketName": {
            "Description": "The S3 bucket where the skill code is stored",
            "Type": "String"
        },
        "PackagePath": {
            "Description": "The Path within the S3 bucket to the zipped node.js package",
            "Type": "String"
        }
    },
    "Resources": {
        "LambdaDynamoSNSFullAccess": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "LambdaDynamoSnsFullAccess",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "dynamodb:*",
                                        "dax:*",
                                        "application-autoscaling:DeleteScalingPolicy",
                                        "application-autoscaling:DeregisterScalableTarget",
                                        "application-autoscaling:DescribeScalableTargets",
                                        "application-autoscaling:DescribeScalingActivities",
                                        "application-autoscaling:DescribeScalingPolicies",
                                        "application-autoscaling:PutScalingPolicy",
                                        "application-autoscaling:RegisterScalableTarget",
                                        "cloudwatch:DeleteAlarms",
                                        "cloudwatch:DescribeAlarmHistory",
                                        "cloudwatch:DescribeAlarms",
                                        "cloudwatch:DescribeAlarmsForMetric",
                                        "cloudwatch:GetMetricStatistics",
                                        "cloudwatch:ListMetrics",
                                        "cloudwatch:PutMetricAlarm",
                                        "datapipeline:ActivatePipeline",
                                        "datapipeline:CreatePipeline",
                                        "datapipeline:DeletePipeline",
                                        "datapipeline:DescribeObjects",
                                        "datapipeline:DescribePipelines",
                                        "datapipeline:GetPipelineDefinition",
                                        "datapipeline:ListPipelines",
                                        "datapipeline:PutPipelineDefinition",
                                        "datapipeline:QueryObjects",
                                        "ec2:DescribeVpcs",
                                        "ec2:DescribeSubnets",
                                        "ec2:DescribeSecurityGroups",
                                        "iam:GetRole",
                                        "iam:ListRoles",
                                        "sns:CreateTopic",
                                        "sns:DeleteTopic",
                                        "sns:ListSubscriptions",
                                        "sns:ListSubscriptionsByTopic",
                                        "sns:ListTopics",
                                        "sns:Subscribe",
                                        "sns:Unsubscribe",
                                        "sns:SetTopicAttributes",
                                        "lambda:CreateFunction",
                                        "lambda:ListFunctions",
                                        "lambda:ListEventSourceMappings",
                                        "lambda:CreateEventSourceMapping",
                                        "lambda:DeleteEventSourceMapping",
                                        "lambda:GetFunctionConfiguration",
                                        "lambda:DeleteFunction"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sns:*"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:getObject",
                                    "Resource": {
                                        "Fn::Join": [
                                            "",
                                            [
                                                "arn:aws:s3:::",
                                                {"Ref":"BucketName"},
                                                "/",
                                                {"Ref":"PackagePath"}
                                            ]
                                        ]
                                    }   
                                }
                            ]
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "461d03eb-ce00-460e-80ed-dff743581275"
                }
            }
        },
        "AlexaSkillFunction": {
            "Type": "AWS::Lambda::Function",
            "DependsOn": "LambdaDynamoSNSFullAccess",
            "Properties": {
                "FunctionName": {
                    "Ref": "FunctionName"
                },
                "Handler": "index.handler",
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaDynamoSNSFullAccess",
                        "Arn"
                    ]
                },
                "Description": {
                    "Fn::Join": [
                        "",
                        [
                            "Alexa Skill code for the ",
                            {
                                "Ref": "FunctionName"
                            },
                            " skill."
                        ]
                    ]
                },
                "Code": {
                    "S3Bucket": {
                        "Ref": "BucketName"
                    },
                    "S3Key": {
                        "Ref": "PackagePath"
                    }
                },
                "Runtime": "nodejs6.10",
                "Timeout": "10"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                }
            }
        },
        "AlexaSkillFunctionPermissions": {
            "Type": "AWS::Lambda::Permission",
            "DependsOn": "AlexaSkillFunction",
            "Properties": {
                "FunctionName": {
                    "Ref": "AlexaSkillFunction"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "alexa-appkit.amazon.com"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b265f951-0794-4d2a-8ac3-fd2a910ff5bb"
                }
            }
        },
        "AlexaSkillDynamoDb": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "AttributeDefinitions": [
                    {
                        "AttributeName": "UserId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "UserId",
                        "KeyType": "HASH"
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 5,
                    "WriteCapacityUnits": 5
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c033dec6-4f1a-4c54-b4b0-475db48e8a4a"
                }
            },
            "DependsOn": [
                "AlexaSkillFunction"
            ]
        },
        "AlexaSkillSNS": {
            "Type": "AWS::SNS::Topic",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e8684a9b-33b4-42b5-a367-3d87c5f1045a"
                }
            },
            "DependsOn": [
                "AlexaSkillFunction"
            ]
        }
    },
    "Outputs": {
        "SnsTopicName": {
            "Value": {
                "Fn::GetAtt": [
                    "AlexaSkillSNS",
                    "TopicName"
                ]
            },
            "Description": "SNS Topic Name"
        },
        "DynamoDbTable": {
            "Value": {
                "Fn::GetAtt": [
                    "AlexaSkillDynamoDb",
                    "Arn"
                ]
            },
            "Description": "DynamoDb Table ARN"
        },
        "FunctionARN": {
            "Value": {
                "Fn::GetAtt": [
                    "AlexaSkillFunction",
                    "Arn"
                ]
            },
            "Description": "Lambda function ARN to be placed in the Amazon Developer Portal"
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "e8684a9b-33b4-42b5-a367-3d87c5f1045a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 60,
                    "y": 90
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                ]
            },
            "c033dec6-4f1a-4c54-b4b0-475db48e8a4a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 180,
                    "y": 90
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                ]
            },
            "461d03eb-ce00-460e-80ed-dff743581275": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 60,
                    "y": 210
                },
                "z": 1,
                "embeds": []
            },
            "f83b0923-6d30-4aef-b62f-984aaa6ef15f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 180,
                    "y": 210
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "461d03eb-ce00-460e-80ed-dff743581275"
                ],
                "isrelatedto": [
                    "461d03eb-ce00-460e-80ed-dff743581275"
                ]
            },
            "b265f951-0794-4d2a-8ac3-fd2a910ff5bb": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 300,
                    "y": 90
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                ],
                "dependson": [
                    "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                ]
            },
            "b8e592d6-a104-4db4-a635-966b916a4d77": {
                "source": {
                    "id": "e8684a9b-33b4-42b5-a367-3d87c5f1045a"
                },
                "target": {
                    "id": "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                },
                "z": 11
            },
            "65f04d91-83a2-4745-8b9b-134b63f96e58": {
                "source": {
                    "id": "c033dec6-4f1a-4c54-b4b0-475db48e8a4a"
                },
                "target": {
                    "id": "f83b0923-6d30-4aef-b62f-984aaa6ef15f"
                },
                "z": 12
            }
        }
    }
}